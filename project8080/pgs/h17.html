<html>

<!-- Mirrored from davidwallace2000.home.comcast.net/~davidwallace2000/h8/project8080_archive/pgs/h17.html by HTTrack Website Copier/3.x [XR&CO'2010], Mon, 10 Sep 2012 13:15:46 GMT -->

<head>
    <title>H8 Emulation Help - H-17 Disk System</title>
    <meta name="AppleTitle" content="H8 Emulation Help">
    <meta name="description" content="H-17 Disk System">
</head>

<!-- updated 11/17/2002, das -->

<body bgcolor="white">
    <p>
        <font size=3 face="Verdana,Geneva" color="0000FF">
            <b>H-17 Disk System</b>
        </font>
        <ul>
            <font face="geneva" size=2>
                <p>The H-17 disk system hardware and software implement a two-level file system. The lower layer is an array of sectors that can be read and written by sector number, and which is accessed by calling the H-17 disk driver. The higher layer
                    is the HDOS-imposed file system with a directory and disk cluster allocation chains, using the low-level driver to access the sector array.</p>
                <p>This page will document the low-level driver calls and show you how to use them to access the sector array yourself. A short example is included. A longer, more comprehensive example, Diskdump, can be downloaded from the project web site.</p>
                <p>This page will also document the format of the label, the directory, and the Group Reservation Table, all essential to understanding how HDOS operates the file system on top of the low-level sector array.</p>
                <p><b>One caution:</b> Unless you really know what you are doing, the author strongly suggests that you <b>read</b> but <b>not write</b> using the low-level driver. If you are going to try writing, use a copy of the diskette image. It's very
                    easy to corrupt the disk and lose your files.</p>
            </font>
        </ul>

        <hr>
        <font face="Geneva,Arial" size=1>
            <a name="top"></a>
            <center>
                <a href="program.html">Programming Table of Contents</a>
                <br><br>
                <a href="../h8_toc.html">Main Table of Contents</a>
            </center>
            <hr>

            <table border="0" cellspacing="0" cellpadding="2">
                <tr align="left" valign="top">
                    <td width="125">
                        <font size=3 face="Verdana,Geneva" color="0000FF"><b>Page Index</b></font>
                    </td>
                    <td>
                        <font face="Geneva,Arial" size=2>
                            <a href="#h17">H-17 Disk Format</a><br>
                        </font>
                    </td>
                    <td>
                        <font face="Geneva,arial" size=2>
                            <a href="#label">Label</a><br>
                            <a href="#grt">Group Reservation Table (GRT)</a><br>
                            <a href="#directory">Directory</a><br>
                        </font>
                    </td>
                </tr>
                <tr align="left" valign="top">
                    <td>&nbsp;</td>
                    <td>
                        <font face="Geneva,arial" size=2>
                            <a href="#lowlevel">Low-Level Driver Calls</a><br>
                        </font>
                    </td>
                    <td>
                        <font face="Geneva,arial" size=2>
                            <a href="#regs">Register Usage</a><br>
                            <a href="#dread">Read</a><br>
                            <a href="#dwrite">Write</a><br>
                            <a href="#dreadr">Read Regardless</a><br>
                            <a href="#dabort">Abort</a><br>
                            <a href="#dmount">Mount</a><br>
                            <a href="#dready">Ready</a><br>
                        </font>
                    </td>
                </tr>
                <tr align="left" valign="top">
                    <td>&nbsp;</td>
                    <td>
                        <font face="Geneva,arial" size=2>
                            <a href="#sample">Sample Program</a><br>
                        </font>
                    </td>
                    <td>&nbsp;</td>
                </tr>
            </table>
            <hr>

            <font face="Geneva,Arial" size=2 color="#0000FF">
                <p>
                    <a name="h17"></a>
                    <b>H-17 Disk Format</b></p>
            </font>
            <ul>
                <font face="geneva,arial" size=2>
                    <p>An H-17 disk consists of an array of 256-byte sectors numbered from zero through the maximum number of sectors possible for the given disk format, minus 1. The original 100K-byte disks had 400 sectors, so sector numbers were 0-399.
                        Double-sided 40-track and single-sided 80-track disks each have 800 sectors. Double-sided 80-track disks have 1,600 sectors.</p>
                    <p>Each sector consists of two parts: a header and a body. The body consists of 256 data bytes followed by a checksum. The header contains:</p>
                </font>

                <ul type="disc">
                    <li>
                        <font face="geneva,arial" size=2>the disk's volume serial number;</font>
                    </li>
                    <li>
                        <font face="geneva,arial" size=2>the relative track number on the disk, calculated in Basic as INT(sector/10);</font>
                    </li>
                    <li>
                        <font face="geneva,arial" size=2>the relative sector number on the track, calculated in Basic as sector-(track * 10);</font>
                    </li>
                    <li>
                        <font face="geneva,arial" size=2>a checksum byte.</font>
                    </li>
                </ul>

                <font face="geneva,arial" size=2>
                    <p>There are 10 sectors per track. Sectors 0-9 are on track zero (ex: INT(9/10) = 0), relative sectors 0-9 (ex: 9-0 = 9). Sectors 10-19 are on track one (ex: INT(16/10) = 1, relative sectors 0-9 (ex: 16-(1*10) = 6. Sector 127 is on track
                        12, relative sector 7.</p>

                    <p>This calculation is also done in the other direction. Track 30 relative sector 3 is 30*10+3 = sector number 303.</p>

                    <p>The volume serial number is used to make sure that HDOS is operating on the correct disk; this validation helps prevent disk corruption problems. The sector headers on sectors 10-n contain the serial number given to the disk when it
                        was initialized. The serial number recorded in the first 10 sectors is zero so that HDOS can read the first 10 sectors without knowing the serial number. As you'll see, the volume serial number is recorded in sector #9 as part
                        of the <a href="#label">label</a>. Sectors 0-8 contain the boot program.</p>

                    <p><a href="#top">go to top</a></p>
                </font>

                <font face="geneva,arial" size=2>
                    <p>
                        <a name="label"></a>
                        <b>Label</b></p>
                    <p>The label, in sector #9, contains information that allows HDOS to understand the size and format of the disk, and the location of the <a href="#directory">directory</a> and the <a href="#grt">Group Reservation Table (GRT)</a>, which
                        enables high-level file access.</p>
                    <p>The label is formatted as follows.</p>
                </font>

                <table border="1" cellspacing="0" cellpadding="4">
                    <caption>
                        <font face="Geneva,Arial" size=2><b>Label Layout</b></caption>
                    <tr align="center" valign="top">
                        <th>
                            <font face="Geneva,Arial" size=2>Offset</font>
                        </th>
                        <th>
                            <font face="Geneva,Arial" size=2>Length</font>
                        </th>
                        <th align="left">
                            <font face="Geneva,Arial" size=2>Name</font>
                        </th>
                        <th align="left">
                            <font face="Geneva,Arial" size=2>Description</font>
                        </th>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>0</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>1</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.ser</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Disk volume serial number, recorded in the header of sectors 10-n</font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>1</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>2</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.ind</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2><a href="memory.html#dates">Date</a> disk was initialized</font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>3</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>2</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.dis</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Sector index of the first <a href="#directory">directory</a> block</font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>5</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>2</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.grt</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Logical sector number of the <a href="#grt">Group Reservation Table (GRT)</a></font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>7</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>1</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.spg</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Sectors per group (2, 4 or 8)</font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>8</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>1</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.vlt</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Volume type:<br> &nbsp;&nbsp;0 = Data-only volume<br> &nbsp;&nbsp;1 = Bootable volume<br> &nbsp;&nbsp;2 = Disk with no directory
                            </font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>9</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>1</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.ver</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Version of init.abs that initialized the disk</font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>10</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>2</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.rgt</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Logical sector number of the Reserved Group Table (RGT)</font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>12</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>2</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.siz</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Number of sectors on the disk</font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>14</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>2</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.pss</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Physical sector size (constant 256)</font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>16</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>1</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.vfl</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Volume flags<br> &nbsp;&nbsp;00000000B - 40 tracks, 1 side<br> &nbsp;&nbsp;00000001B - 40 tracks, 2 sides<br> &nbsp;&nbsp;00000010B - 80 tracks, 1 side<br> &nbsp;&nbsp;00000011B - 80 tracks, 2 sides
                            </font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>17</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>60</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.lab</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Printable volume label</font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>77</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>2</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>&nbsp;</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>reserved</font>
                        </td>
                    </tr>
                    <tr align="center" valign="top">
                        <td>
                            <font face="Geneva,Arial" size=2>79</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>1</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>lab.spt</font>
                        </td>
                        <td align="left">
                            <font face="Geneva,Arial" size=2>Sectors per track (constant 10)</font>
                        </td>
                    </tr>
                </table>

                <font face="geneva,arial" size=2>
                    <p>The remaining 176 bytes of sector #9 are unused.</p>
                    <p>lab.ser is used to mount the disk and allow the driver to access sectors 10-n of the disk, which have the serial number recorded as part of the sector header.</p>
                    <p>
                        <a name="size"></a>
                        The size and format of the disk can be determined by looking at the following label fields.</p>
                </font>


                <ul>
                    <table border="1" cellspacing="0" cellpadding="4">
                        <caption>
                            <font face="Geneva,Arial" size=2><b>Disk Size Determination</b></caption>

                        <tr align="center" valign="top">
                            <th colspan=4>
                                <font face="Geneva,Arial" size=2>Label Fields</font>
                            </th>
                            <th colspan=2>
                                <font face="Geneva,Arial" size=2>Disk Format</font>
                            </th>
                        </tr>
                        <tr align="center" valign="top">
                            <td>
                                <font face="Geneva,Arial" size=2>lab.ver</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>lab.vfl</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>lab.siz</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>lab.spg</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>Tracks</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>Sides</font>
                            </td>
                        </tr>
                        <tr align="center" valign="top">
                            <td>
                                <font face="Geneva,Arial" size=2>16h</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>n/a</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>0</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>2</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>40</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>1</font>
                            </td>
                        </tr>
                        <tr align="center" valign="top">
                            <td>
                                <font face="Geneva,Arial" size=2>20h</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>00000000B</font>
                            </td>
                            <td align="right">
                                <font face="Geneva,Arial" size=2>400d</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>2</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>40</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>1</font>
                            </td>
                        </tr>
                        <tr align="center" valign="top">
                            <td>
                                <font face="Geneva,Arial" size=2>20h</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>00000001B</font>
                            </td>
                            <td align="right">
                                <font face="Geneva,Arial" size=2>800d</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>4</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>40</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>2</font>
                            </td>
                        </tr>
                        <tr align="center" valign="top">
                            <td>
                                <font face="Geneva,Arial" size=2>20h</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>00000010B</font>
                            </td>
                            <td align="right">
                                <font face="Geneva,Arial" size=2>800d</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>4</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>80</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>1</font>
                            </td>
                        </tr>
                        <tr align="center" valign="top">
                            <td>
                                <font face="Geneva,Arial" size=2>20h</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>00000011B</font>
                            </td>
                            <td align="right">
                                <font face="Geneva,Arial" size=2>1600d</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>8</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>80</font>
                            </td>
                            <td>
                                <font face="Geneva,Arial" size=2>2</font>
                            </td>
                        </tr>
                    </table>
                </ul>

                <font face="geneva,arial" size=2>
                    <p><a href="#top">go to top</a></p>
                </font>

                <font face="geneva,arial" size=2>
                    <p>
                        <a name="grt"></a>
                        <b>Group Reservation Table (GRT)</b></p>
                    <p>HDOS allocates disk space to files in groups of sectors. There are a fixed number of groups - 200 - available on each disk, no matter the size or format of the disk. Thus the theoretical maximum number of files on a disk is 200, with
                        larger disks allowing those files to be larger.</p>
                    <p>The label field lab.spg contains the number of sectors per group for this disk, which will be 2, 4, or 8 depending on the disk format. (Ref: <a href="#size">Disk Size Determination</a>)</p>
                    <p>HDOS uses a chained allocation table to track groups of sectors; this table is called the Group Reservation Table, or GRT. The <a href="#directory">directory</a> entry for the file contains the first GRT index for the file. The GRT
                        byte at that offset contains the next index, and so on, with each new index representing potentially "lab.spg" sectors. The last index in the file has a value of zero, terminating the chain.</p>
                    <p>
                        <a name="grtexample"></a>Consider the directory entry for PIE.ABS on the author's 40x2 system disk (all values octal):</p>
                    <font face="courier">
                        &nbsp;&nbsp;120 111 105 000 000 000 000 000 101 102 123<br> &nbsp;&nbsp;000 000 003 040 000 <u>124 142</u> 001<br>
                    </font>
                    <p>The two underlined bytes are the first and last group numbers, offsets into the GRT (ref: <a href="#directory">directory</a>). Here is the applicable section of the GRT for this disk (all values octal):</p>
                    <font face="courier">
                        &nbsp;&nbsp;Offset-&nbsp;&nbsp;Data---------------------------<br> &nbsp;&nbsp;000.120&nbsp;&nbsp;121 000 123 131 <u>125 126 127 140</u><br> &nbsp;&nbsp;000.130&nbsp;&nbsp;000 132 133 137 135 136 000 143<br> &nbsp;&nbsp;000.140&nbsp;&nbsp;
                        <u>141 142 000</u> 155 145 146 147 150<br>
                    </font>
                    <p>The group chain for the file PIE.ABS is underlined.</p>
                    <p>At offset 124 - the first group of sectors in this file - we find the index of the next set of sectors, 125. At offset 125, we find the index to the next set, 126, and so on. The first four groups and last three groups are contiguous,
                        with a gap of eight groups between the two segments of the file. </p>
                    <p>This program takes seven groups of sectors. This disk uses four sectors per group, so the file is taking up 28 sectors of the disk. (The actual file size is 25 sectors; ref: <a href="#directory">directory</a>.)</p>
                    <p>To determine the physical sector index in the low-level disk sector array, multiply the group number by the number of sectors per group. The first sector of PIE.ABS can be found in 124Q = 84 * 4 = sector 336 (track 33 sector 6). You
                        would use this index with the low-level <a href="#dread">read</a> function to read the first sector of the file.</p>
                    <p>The byte at offset zero into the GRT contains the index of the first group of free sectors, those sectors not yet allocated to any file. The free group list is chained just like a file. To determine the number of free sectors on a
                        disk, you can follow this chain counting "lab.spg" sectors for every non-zero index in the chain.</p>

                    <font face="geneva,arial" size=2>
                        <p><a href="#top">go to top</a></p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p>
                            <a name="directory"></a>
                            <b>Directory</b></p>
                        <p>The directory is a file that's positioned close to the physical center of the disk for rapid access. The directory is made up of xxxxxxxx directory blocks, each of which is 512 bytes long. Each block contains 22 directory entries.</p>
                        <p>Here is the layout of a single directory entry:</p>
                    </font>

                    <ul>
                        <table border="1" cellspacing="0" cellpadding="4">
                            <caption>
                                <font face="Geneva,Arial" size=2><b>Directory Entry Layout</b></caption>
                            <tr align="center" valign="top">
                                <th>
                                    <font face="Geneva,Arial" size=2>Offset</font>
                                </th>
                                <th>
                                    <font face="Geneva,Arial" size=2>Length</font>
                                </th>
                                <th align="left">
                                    <font face="Geneva,Arial" size=2>Name</font>
                                </th>
                                <th align="left">
                                    <font face="Geneva,Arial" size=2>Description</font>
                                </th>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>0</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>8</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.nam</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>File name</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>8</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>3</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.ext</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>File name extension</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>11</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>1</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.pro</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>Project (unused, set to 0)</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>12</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>1</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.ver</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>File version (unused, set to 0)</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>13</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>1</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.clu</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>Cluster factor</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>14</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>1</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.flg</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>Flags:<br> &nbsp;&nbsp;10000000B - system file (S)<br> &nbsp;&nbsp;01000000B - flags locked (L)<br> &nbsp;&nbsp;00100000B - write protected (W)<br> &nbsp;&nbsp;00010000B - contiguous (C)
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>15</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>1</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>&nbsp;</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>reserved</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>16</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>1</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.fgn</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>First <a href="#grt">group</a> number</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>17</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>1</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.lgn</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>Last <a href="#grt">group</a> number</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>18</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>1</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.lsi</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>Last sector index (in last group)</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>19</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>2</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.crd</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>File creation <a href="memory.html#dates">date</a></font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>21</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>2</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.ald</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>File alteration <a href="memory.html#dates">date</a></font>
                                </td>
                            </tr>
                        </table>
                    </ul>

                    <font face="Geneva,Arial" size=2>
                        <p>Of interest here are the first group index, dir.fgn, the last group index, dir.lgn, and the last sector index, dir.lsi. HDOS uses dir.fgn to find the front of the file, and dir.lgn to find the back when you are adding on to an
                            existing file.</p>
                        <p>The last sector index, dir.lsi, is used to tell how many sectors are actually used in the last group allocated to the file. Refer to the GRT <a href="#grtexample">example</a> above. PIE.ABS uses seven groups, each of which contains
                            four sectors, so the file is occupying 7*4=28 sectors. But dir.lsi is 001Q, indicating that only the first sector in the last group is actually part of the file. So the file is really 6*4+1=25 sectors in length, with three
                            sectors "wasted."</p>
                        <p>As noted above, each directory block contains 22 directory entries. The layout of a directory block is:</p>
                    </font>

                    <ul>
                        <table border="1" cellspacing="0" cellpadding="4">
                            <caption>
                                <font face="Geneva,Arial" size=2><b>Directory Block Layout</b></caption>
                            <tr align="center" valign="top">
                                <th>
                                    <font face="Geneva,Arial" size=2>Offset</th>
                                <th>
                                    <font face="Geneva,Arial" size=2>Length</th>
                                <th align="left">
                                    <font face="Geneva,Arial" size=2>Name</th>
                                <th align="left">
                                    <font face="Geneva,Arial" size=2>Description</th>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>0</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>506</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>-</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>22 directory entries</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>506</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>1</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>-</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>constant 000q</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>507</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>1</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.enl</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>Entry length (027q)</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>508</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>2</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.sec</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>Sector index of beginning of this block</font>
                                </td>
                            </tr>
                            <tr align="center" valign="top">
                                <td>
                                    <font face="Geneva,Arial" size=2>510</font>
                                </td>
                                <td>
                                    <font face="Geneva,Arial" size=2>2</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>dir.lnk</font>
                                </td>
                                <td align="left">
                                    <font face="Geneva,Arial" size=2>Sector index of beginning of next block</font>
                                </td>
                            </tr>
                        </table>
                    </ul>

                    <font face="geneva,arial" size=2>
                        <p>HDOS reads the directory using low-level driver calls. The sector index of the first directory block is found in <a href="#label">label</a> field lab.dis. The end of each directory block contains the sector index of the next directory
                            block (zero in the last directory block) so HDOS can easily follow the directory across the disk surface without using the high-level file system, speeding directory access.</p>
                        <p><a href="#top">go to top</a></p>
                    </font>
            </ul>

            <hr>

            <font face="Geneva,Arial" size=2 color="#0000FF">
                <p>
                    <a name="lowlevel"></a>
                    <b>Low-Level Driver Calls</b></p>
            </font>
            <ul>
                <font face="geneva,arial" size=2>
                    <p>There are eleven functions that can be provided by an HDOS driver; the complete list is in the following table. The low-level disk driver supports six of these functions.</p>
                </font>

                <table border="1" cellspacing="0" cellpadding="4">
                    <caption>
                        <font face="Geneva,Arial" size=2><b>Low-Level Driver Functions</b></font>
                    </caption>

                    <tr align="left" valign="bottom">
                        <th>
                            <font face="Geneva,Arial" size=2>Octal<br>Code</font>
                        </th>
                        <th>
                            <font face="Geneva,Arial" size=2>Function</font>
                        </th>
                        <th>
                            <font face="Geneva,Arial" size=2>Description</font>
                        </th>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>000Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2><a href="#dread">READ</a></font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>Read one or more contiguous sectors from the disk surface.</font>
                        </td>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>001Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2><a href="#dwrite">WRITE</a></font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>Write one or more contiguous sectors to the disk surface.</font>
                        </td>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>002Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2><a href="#dreadr">READR</a></font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>Read one or more contiguous sectors from the disk surface, regardless of serial number protection. Used to read sectors from track zero of an already-mounted disk.</font>
                        </td>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>003Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>OPENR</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>
                                <font color="#FF0000">Not used with the low-level driver.</font> Open a file for read access.</font>
                        </td>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>004Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>OPENW</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>
                                <font color="#FF0000">Not used with the low-level driver.</font> Open a file for write access.</font>
                        </td>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>005Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>OPENU</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>
                                <font color="#FF0000">Not used with the low-level driver.</font> Open a file for update access.</font>
                        </td>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>006Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>CLOSE</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>
                                <font color="#FF0000">Not used with the low-level driver.</font> Close an open file.</font>
                        </td>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>007Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2><a href="#dabort">ABORT</a></font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>Abort (e.g., clean up) the driver.</font>
                        </td>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>010Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2><a href="#dmount">MOUNT</a></font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>Perform a low-level disk mount.</font>
                        </td>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>011Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>LOADD</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>
                                <font color="#FF0000">Not a user function.</font> Called when the driver is loaded into memory.</font>
                        </td>
                    </tr>
                    <tr align="left" valign="middle">
                        <td align="center">
                            <font face="Geneva,Arial" size=2>012Q</font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2><a href="#dready">READY</a></font>
                        </td>
                        <td>
                            <font face="Geneva,Arial" size=2>Check a drive to determine whether a disk is inserted and spinning.</font>
                        </td>
                    </tr>
                </table>

                <font face="geneva,arial" size=2>
                    <p>(Note: LOADD is invoked when the driver is loaded using the <a href="scalls.html#loadd">.LOADD syscall</a>. This function should not be called directly by your program.)</p>
                    <p>To invoke a driver function, store the appropriate physical drive number (0, 1, or 2) into the field <a href="memory.html#hdosram">AIO.UNI</a> (41.061A), load the <a href="#regs">registers</a> as appropriate for the function you are
                        calling, load the function code into register (A), and call <a href="memory.html#hdosram">D.SYDD</a> (40.130A). Both AIO.UNI and D.SYDD are included in the common deck HDOSRAM.ACM distributed on the Extras disk.</p>
                    <p>Register usage and documentation for each call are included below, and several are used in the <a href="#sample">sample</a> program.</p>
                    <p><a href="#top">go to top</a></p>
                </font>

                <font face="geneva,arial" size=2>
                    <p>
                        <a name="regs"></a>
                        <b>Register Usage</b></p>
                    <p>In all cases, register (A) must contain the function code when you call D.SYDD.</p>
                    <p>The data transfer functions <a href="#dread">read</a>, <a href="#dwrite">write</a>, and <a href="#dreadr">read regardless</a> use the following registers: </p>
                    <font face="courier">
                        &nbsp;&nbsp;(A)&nbsp; = <a href="#lowlevel">function code</a><br> &nbsp;&nbsp;(HL) = <a href="#h17">sector index</a><br> &nbsp;&nbsp;(DE) = buffer address (same as the <a href="scalls.html#read">.READ</a> scall)<br> &nbsp;&nbsp;(BC)
                        = read length (same as the <a href="scalls.html#read">.READ</a> scall)<br>
                    </font>
                    <p>On return from the call:</p>
                    <font face="courier">
                        &nbsp;&nbsp;'C' flag set if error<br> &nbsp;&nbsp;&nbsp;&nbsp;(A)&nbsp;&nbsp; = <a href="scalls.html#errtab">error code</a><br> &nbsp;&nbsp;(DE) = advanced past bytes successfully read/written<br> &nbsp;&nbsp;(BC) = reduced by
                        bytes successfully read/written<br>
                    </font>
                    <p><a href="#dmount">Mount</a> uses the following registers:</p>
                    <font face="courier">
                        &nbsp;&nbsp;(A)&nbsp; = <a href="#lowlevel">function code</a><br> &nbsp;&nbsp;(L)&nbsp; = <a href="#label">volume serial number</a> (lab.ser)<br>
                    </font>
                    <p><a href="#dabort">Abort</a> and <a href="#dready">Ready</a> only require the function code in register (A).</p>
                    <font face="geneva,arial" size=2>
                        <p><a href="#top">go to top</a></p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p>
                            <a name="dread"></a>
                            <b>Read</b></p>
                        <p>Reads one or more sectors starting from the sector index in (HL) and stores them at (DE). The number of bytes to be read is passed in (BC).</p>
                        <p>Make sure to set <a href="memory.html#hdosram">AIO.UNI</a> to the physical drive number (0, 1, or 2) before calling <a href="memory.html#hdosram">D.SYDD</a>. If you use any of the file system scalls between driver calls, you can
                            count on AIO.UNI having been changed.</p>
                        <p>Look back at the PIE.ABS <a href="#grtexample">example</a> in the <a href="#grt">GRT</a> section. That program can be read into memory in two calls to the low-level driver:</p>
                        <font face="courier">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,0<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AIO.UNI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assume device 0<br>                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H,336&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;First segment, first sector index<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B,4*4*256&nbsp;&nbsp;&nbsp;4
                            grps, 4 sect/grp, 256 bytes/sect<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D,42200Q
                            <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ function code<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;&nbsp;&nbsp;&nbsp;D.SYDD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Read
                            first bit<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ERROR
                            <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H,388&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2nd segment, 1st sect ndx<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B,9*256&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nine
                            sectors left<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,0
                            <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;&nbsp;&nbsp;&nbsp;D.SYDD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Read the 2nd chunk<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ERROR
                            <br>
                        </font>
                        <p>The HDOS <a href="scalls.html#read">.READ</a> scall requires that all disk I/O be performed in multiples of 256 bytes, but the driver's read function doesn't have that same requirement. There is one example of a short read of only
                            80 bytes, which you can locate in the HUG enhanced SY: driver, available from the project web site. It's not clear what happens when there are errors on a short read, since the sector's checksum won't be read and processed.</p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p><a href="#top">go to top</a></p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p>
                            <a name="dwrite"></a>
                            <b>Write</b></p>
                        <p>This function call is set up the same as read and uses the same registers, but sectors are written to the disk, not read.</p>
                        <p>Writes <b>must</b> be performed in 256-byte units.</p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p><a href="#top">go to top</a></p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p>
                            <a name="dreadr"></a>
                            <b>Read Regardless</b></p>
                        <p>This function call is the same as read, but allows you to read sectors on track zero of a disk that's already been mounted with its correct volume serial number.</p>
                        <p>Normally, read verifies that the serial number in each sector read is the same as the serial number that the disk was mounted with. But track zero has zeros in the volume serial number field of the sector header. Read Regardless
                            expects a volume serial number of zero, which makes it possible to read sectors from track zero without remounting the disk.</p>
                        <p>Use this function if you want to read the label of a disk that's already been mounted.</p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p><a href="#top">go to top</a></p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p>
                            <a name="dabort"></a>
                            <b>Abort</b></p>
                        <p>Abort cleans up the driver from any past errors. This should be used at least once in any program that uses low-level driver calls to make sure that the driver is ready to access your disk.</p>
                        <p>I would recommend that you delay 300-500ms after aborting the driver before trying to mount or read to help prevent I/O errors. This is not necessary between an abort and a ready check.</p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p><a href="#top">go to top</a></p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p>
                            <a name="dmount"></a>
                            <b>Mount</b></p>
                        <p>This function does a low-level mount of the physical drive in AIO.UNI, recording the volume serial number to enable serial number verification during subsequent reads.</p>
                        <p>Note that this is a low-level mount that has nothing to do with the high-level mount invoked by the mount <a href="heathkit.html#command">command</a> or the <a href="scalls.html#mount">.MOUNT</a> scall. If you expect to use the
                            high-level file system to access the disk, you will have to use the high-level .MOUNT scall. This mount is good only for low-level driver access.</p>
                        <p>Before calling mount, make sure the correct physical device number is in AIO.UNI, and load the volume serial number into register (L).</p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p><a href="#top">go to top</a></p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p>
                            <a name="dready"></a>
                            <b>Ready</b></p>
                        <p>This function tests whether there's a disk inserted in the drive named in AIO.UNI by turning on the motors and counting sector holes. If there is no disk inserted in the drive, the ready call returns with the 'C' (carry) flag set.
                            If there is a disk in the drive, 'C' is clear on return.</p>
                        <p>The disk does not have to be mounted or otherwise accessible to HDOS or the driver in order to use the ready function.</p>
                    </font>

                    <font face="geneva,arial" size=2>
                        <p><a href="#top">go to top</a></p>
                    </font>

            </ul>

            <hr>

            <font face="Geneva,Arial" size=2 color="#0000FF">
                <p>
                    <a name="sample"></a>
                    <b>Sample Program</b></p>
            </font>
            <ul>
                <font face="geneva,arial" size=2>
                    <p>The following very short program uses several of the low-level driver functions in order to read a disk's label and it's first directory block. A set of notes keyed to the source code follows the code.</p>
                </font>

                <font face="courier" size=2>

                    *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Using low-level disk driver calls, mount a disk<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and read the first directory block.<br> *
                    <br>
                    <a href="memory.html#hdosram">AIO.UNI</a>&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41061A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Disk unit number (0, 1, 2)<br>
                    <a href="memory.html#hdosram">D.SYDD</a>&nbsp;&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;40130A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Addr of jump to driver<br>
                    <a href="#label">LAB.SER</a>&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label offset of volume serial number<br>
                    <a href="#label">LAB.DIS</a>&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label offset of first directory sector<br> *
                    <br> DC.REA&nbsp;&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <a href="#lowlevel">000Q</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Read driver command<br> DC.ABT&nbsp;&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <a href="#lowlevel">007Q</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Abort the driver<br> DC.MOU&nbsp;&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <a href="#lowlevel">010Q</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mount driver command<br> DC.RDY&nbsp;&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <a href="#lowlevel">012Q</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Check for disk ready<br>
                    <a href="scalls.html#exit">.EXIT</a>&nbsp;&nbsp;&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exit HDOS scall command<br>
                    <a href="scalls.html#print">.PRINT</a>&nbsp;&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print HDOS scall command<br> *
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ORG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100000A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Above dbug<br> *
                    <br> START&nbsp;&nbsp;&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
                    <br> *

                    <br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;See note 1<br> *
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,1

                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AIO.UNI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set unit number<br> *

                    <br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;See note 2<br> *
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,DC.ABT

                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;&nbsp;&nbsp;&nbsp;D.SYDD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Clean up the driver<br> *
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H,MNT.MSG
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SCALL&nbsp;&nbsp;&nbsp;.PRINT
                    <br> *
                    <br> READY&nbsp;&nbsp;&nbsp;EQU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
                    <br> *

                    <br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;See note 3<br> *
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,

                    <a href="#dready">DC.RDY</a><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;&nbsp;&nbsp;&nbsp;D.SYDD
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Wait for ready<br> *

                    <br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;See note 4<br> *
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(L) = Volume number<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,
                    <a href="#dmount">DC.MOU</a><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;&nbsp;&nbsp;&nbsp;D.SYDD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mount as volume zero<br> *
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H,9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sector ndx of label<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D,LABEL
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B,256&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 sector long<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,
                    <a href="#dread">DC.REA</a><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;&nbsp;&nbsp;&nbsp;D.SYDD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Read the label<br> *

                    <br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;See note 5<br> *
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LDA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

                    <a href="#label">LABEL+LAB.SER</a><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MOV&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L,A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(L) = Volume number<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,
                    <a href="#dmount">DC.MOU</a><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;&nbsp;&nbsp;&nbsp;D.SYDD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remount with correct volume serial<br> *

                    <br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;See note 6<br> *
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LHLD&nbsp;&nbsp;&nbsp;&nbsp;

                    <a href="#label">LABEL+LAB.DIS</a>&nbsp;&nbsp;(HL) = First directory sector<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D,DIRECT
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LXI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B,512&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Two sectors this time<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MVI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,
                    <a href="#dread">DC.REA</a><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;&nbsp;&nbsp;&nbsp;D.SYDD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Read first directory block<br> *

                    <br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;See note 7<br> *
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XRA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set breakpoint here and inspect buffers<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SCALL&nbsp;&nbsp;&nbsp;.EXIT
                    <br> *
                    <br> MNT.MSG&nbsp;DB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Insert a disk into drive SY1:',212Q<br> LABEL&nbsp;&nbsp;&nbsp;DS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;256
                    <br> DIRECT&nbsp;&nbsp;DS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;512
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;START
                    <br>
                </font>

                <font face="geneva,arial" size=2>
                    <p>Notes:</p>

                    <ol>
                        <li>
                            <font face="geneva,arial" size=2>
                                <p>Always ensure that AIO.UNI has the correct device number in it before making a low-level driver call. In this case, we're expecting the disk to be inserted into physical device #1.
                                </p>
                            </font>
                        </li>
                        <li>
                            <font face="geneva,arial" size=2>
                                <p>Aborting the driver cleans up from short reads, errors, and other bad conditions, and ensures that the driver is ready for business.
                                </p>
                            </font>
                        </li>
                        <li>
                            <font face="geneva,arial" size=2>
                                <p>We've asked for a disk to be inserted into device #1. We'll stay in this loop until device #1 is ready; i.e., there is a disk inserted. If there is already a disk in the drive, it will be ready immediately.
                                </p>
                            </font>
                        </li>
                        <li>
                            <font face="geneva,arial" size=2>
                                <p>We could use the Read Regardless call here, but I chose to mount the disk with volume serial number zero and then use Read to get the label. We need the label so we can get the correct serial number, and for the first directory
                                    block index.
                                </p>
                            </font>
                        </li>
                        <li>
                            <font face="geneva,arial" size=2>
                                <p>Having read the label, we can remount the disk with the correct volume serial number in preparation for reading the directory block. If we subsequently had to reread the label, we could use Read Regardless to get it without
                                    remounting the disk.</p>
                            </font>
                        </li>
                        <li>
                            <font face="geneva,arial" size=2>
                                <p>The first directory block sector index is at offset LAB.DIS from the beginning of the label. Note that we're reading two sectors in one call with this read.
                                </p>
                            </font>
                        </li>
                        <li>
                            <font face="geneva,arial" size=2>
                                <p>This disk can be removed from the drive without notifying HDOS. In fact, it hasn't been mounted to HDOS at all - it's only had its volume serial number recorded for low-level driver access - so it's inaccessible to HDOS
                                    proper.
                                </p>
                            </font>
                        </li>
                    </ol>

                    <font face="Geneva,Arial" size=2>
                        <p><a href="#top">go to top</a></p>
                    </font>
            </ul>

            <hr>
            <font face="Geneva,Arial" size=1>
                <center>
                    <a href="program.html">Programming Table of Contents</a>
                    <br><br>
                    <a href="../h8_toc.html">Main Table of Contents</a>
                </center>

            </font>
</body>

<!-- Mirrored from davidwallace2000.home.comcast.net/~davidwallace2000/h8/project8080_archive/pgs/h17.html by HTTrack Website Copier/3.x [XR&CO'2010], Mon, 10 Sep 2012 13:15:46 GMT -->

</html>