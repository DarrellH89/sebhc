<html>
<!-- Mirrored from davidwallace2000.home.comcast.net/~davidwallace2000/h8/project8080_archive/design_time.html by HTTrack Website Copier/3.x [XR&CO'2010], Mon, 10 Sep 2012 13:15:33 GMT -->
<head><title>Heath8080A - Product Design : Time</title><!-- Headers -- common to all pages --><meta name="description" content="This site provides a free Heathkit H8 microcomputer emulator for the Macintosh"><meta name="author" content="David A. Shaw"><link rev="made" href="mailto:&#104;&#101;&#97;&#116;&#104;8080&#97;&#64;&#97;&#111;&#108;.&#99;&#111;&#109;"><meta name="generator" content="Optima PageSpinner for MacOS"><meta name="robots" content="all"><meta name="keywords" content="Heathkit,Heath,H8,H17,H-17,H19,H-19,8080A,Intel 8080A,computer emulation,H8 emulation,Mac,Macintosh,G3,Linux"><style type="text/css">body {background-color: #ffffff}.left   { background:      #ffffff; vertical-align: top; color: blue }.left p { font-family:     verdana        }.head   { background:     #ffffcc; vertical-align: top; color: blue }.head p { font-family:    geneva, arial        }.lhead   { background:     #ffffcc; vertical-align: top; color: blue }.lhead p { font-family:    verdana         }.body   { vertical-align: top;}.body p, ul, ol, dl         { font-family:    geneva, arial         }div.c1 { font-family: geneva, arial;  text-align: center }div.c2 { font-family: geneva, arial;  text-align: right  }a:visited {color: green }a:hover   {color: red; text-decoration: none }p.outside {font-family: geneva, arial;font-size: small;}pre { font-family: courier; font-size: 10px }h1, h2 {font-family: "times new roman" }</style></head><body><a name="top"></a><!-- Page Heading -- common to all pages --><table border="0" cellspacing="0" cellpadding="4" width="100%"><tr>	<td class="lhead">		<p><b>Heath8080A &#8212; Product Design : Time</b></p>	</td>	<td class="head" align="right"><!-- this reads "site" on the index page and "page" on all others -->		<font size="-1"><p>Page last updated</p></font>	</td></tr><tr>	<td class="head">		<font size="-1"><p><a href="index.html" onMouseOver="self.status='Go to home page'; return true">home</a>		&nbsp;&nbsp;<a href="release.html" onMouseOver="self.status='Go to release page'; return true">release</a>		&nbsp;&nbsp;<a href="support.html" onMouseOver="self.status='Go to support page'; return true">support</a>		&nbsp;&nbsp;<a href="design.html" onMouseOver="self.status='Go to design page'; return true">design</a>		&nbsp;&nbsp;<a href="resources.html" onMouseOver="self.status='Go to resources page'; return true">resources</a>		&nbsp;&nbsp;<a href="legal.html" onMouseOver="self.status='Go to legal page'; return true">legal</a>		&nbsp;&nbsp;<a href="sitemap.html" onMouseOver="self.status='Go to site map'; return true">site map</a></p></font>	</td>	<td class="head" align="right">		<font size="-1"><p>14-September-2002</p></font>	</td></tr><tr><td>&nbsp;</td></tr></table><!-- Standard content ends. Page body starts here.  --><table border="0" cellspacing="0" cellpadding="4" width="100%"><tr><!-- page index --><td class="left" width="20%"><font size="-1"><p>On this page</p><p>&#149; <a href="#define" onMouseOver="self.status='Go to defining time'; return true">definition</a><br>&#149; <a href="#creation" onMouseOver="self.status='Go to time creation'; return true">creation</a><br>&#149; <a href="#pacing" onMouseOver="self.status='Go to time creation'; return true">processor pacing</a><br>&#149; <a href="#distribution" onMouseOver="self.status='Go to time distribution'; return true">distribution</a><br></p><p>Related links</p><p>&#149; <a href="design_arch.html" onMouseOver="self.status='Go to system architecture'; return true">system architecture</a><br>&#149; <a href="design_perf.html" onMouseOver="self.status='Go to performance'; return true">performance</a><br></p></font></td><td class="body"><font size="-1"><p><b>Time</b></p><p>Time is a sufficiently significant topic to deserve a page of its own. Stephen Hawking wrote two <b>books</b> on the subject. Well, two that <b>I</b> could read, anyway.</p><p>I'll try to be more brief.</p><hr><a name="define"></a><p><b>Defining Time</b></p><table border="0" cellspacing="0" cellpadding="2"><tr valign="top" align="left">	<td class="body"><font size="-1"><p>Data:</p></td>	<td class="body"><font size="-1"><p>"Can you recommend a way to counter the effect?"</p></td></tr><tr valign="top" align="left">	<td class="body"><font size="-1"><p>Q:</p></td>	<td class="body"><font size="-1"><p>"Simple. Change the gravitational constant of the universe."</p></td></tr><tr valign="top" align="left">	<td class="body"><font size="-1"><p>LaForge:&nbsp;</p></td>	<td class="body"><font size="-1"><p>"What?"</p></td></tr><tr valign="top" align="left">	<td class="body"><font size="-1"><p>Q:</p></td>	<td class="body"><font size="-1"><p>"Change the gravitational constant of the universe, thereby altering the mass of the asteroid."</p></td></tr><tr valign="top" align="left">	<td class="body"><font size="-1"><p>LaForge:&nbsp;</p></td>	<td class="body"><font size="-1"><p>"Redefine gravity. And how am I supposed to do that?"</p></td></tr><tr valign="top" align="left">	<td class="body"><font size="-1"><p>Q:</p></td>	<td class="body"><font size="-1"><p>"You just <b>do</b> it!"</p></td></tr></tr><tr valign="top" align="left">	<td class="body"><font size="-1"><p>Data:</p></td>	<td class="body"><font size="-1"><p>"Geordi is trying to say that changing the gravitational constant of the universe is beyond our capabilities."</p></td></tr><tr valign="top" align="left">	<td class="body"><font size="-1"><p>Q:</p></td>	<td class="body"><font size="-1"><p>"Oh. Well, in that case, never mind."</p></td></tr><tr valign="top" align="right">	<td class="body"></td>	<td class="body"><font size="-2"><p>From ST/TNG "Deja Q" written by Richard Danus</p></td></tr></table><p><i>The Problem</i></p><ul><li><p>In a real H8 system, the H8 unit, its I/O hardware, H-19, H-17, printer, etc., are all separate hardware systems operating in parallel real time. In the emulator, we have to time-slice a single processor to emulate all these components. Gaps are inevitable.</p></li><li><p>A real H8 system doesn't have to contend with a higher-level OS, or a menu system that stops it cold if a user lingers on a menu item.</p></li><li><p>A real H8 operates at its natural speed. The emulator has to run on a range of machines from the fairly slow to the very fast, while attempting to produce a reasonable emulation experience on all of them.</p></li></ul><p>There are other problems. But to get to the point: There is just no way to get a precise emulation of an 8080A processor imbedded in H8 hardware short of throwing hardware at it. Intel and Heathkit did that decades ago: been there, done that.</p><p><i>The Solution</i></p><p>Never let reality get in the way of a good time.</p><p>The component with the greatest time constraints is the H-17 disk system, and since there are no moving parts to get out of sync when we "go away" for a while to browse menus and such, we have the flexibility to provide our own definition of time that suits our requirements better than the version that Einstein gave us.</p><p>As Q said, you just <b>do</b> it. In emulated reality, <b>nothing</b> is beyond our capabilities.</p><table border="1" cellspacing="0" cellpadding="4">	<caption><font size="-1"><p><b>Time Defined</b></p></caption><tr align="left" valign="top">	<td class="body"><font size="-1">	<p><b>Time:</b> That temporal space that exists between the arming of the millisecond timer and our recognition of the expiration of that timer (ref. <a href="#creation" onMouseOver="self.status='Go to time creation'; return true">Time Creation</a>).</p></td></tr></table><p>The disks "spin" during this time, and the processor runs as quickly as we can push it during this time. There are no higher-level Macintosh interruptions during this time. We may drive real-time events, such as character outputs, into other sections of the emulator, but that's about as far afield as we get.</p><p>At the expiration of the millisecond timer, if we haven't already done so, we pause to service the rest of the emulator (ref. <a href="#distribution" onMouseOver="self.status='Go to time distribution'; return true">Time Distribution</a>). Periodically, we ask the Mac for external events, the processing of which can be lightning fast or dog slow.</p><p>When time starts again, the H8 system picks up precisely where it left off, never knowing that there was "a gap in time." As far as HDOS, PAM/8, the disk system and the user program are concerned, this time gap does not exist. It's outside of their universe. The processor does not run. The disks do not spin.</p><p>You can click a menu item and bring the whole thing to a stand-still when the H8's interrupts are down while the SY: driver is executing time-critical code, and when you release the mouse the whole thing will pick up where it left off as if nothing happened.</p><p>Only you, the external observer, will see the effect of your disruption.</p><p><i>Cast Adrift in Time</i></p><p>There are any number of solutions to the time problem all of which create interesting problems of their own. One of the major goals of this project was to produce a good visual representation of the H8's front panel in action, and that tethered me very closely to a 2ms clock tick in real time.</p><img src="gfx/gappytime.gif" width="298" height="113" hspace="4" vspace="4" align="right" border="0" alt="Gappy Time"><p>What we have to deal with, then, is "gappy real time," a condition that's much less socially debilitating than gappy teeth. As you can see from the graphic, H8 software will perceive a rigidly-timed series of 2ms clock "ticks" occurring back to back. It has no external reference point from which to gauge the gaps. We, on the other hand, can use an external clock to measure the variable drift.</p><p>What does this mean to us? Why do we care?</p><ol><li><p>The emulated H8 is absolutely not suitable for any real-time task. Even displaying a digital clock on the screen will be an exercise in frustration.</p></li><li><p>We have to be very careful when discussing limits, benchmarks, their reference points and the mechanisms used to measure them (ref: <a href="design_perf.html" onMouseOver="self.status='Go to performance'; return true">performance</a>).</li></ol><p>There is one additional point related to instruction timing, or the lack thereof, in <a href="support.html#limitations" onMouseOver="self.status='Go to limitations'; return true">limitations</a>. You should understand that material as well.</li><p><i>Further Reading on the Subject of Emulation Time</i></p><p>Dave Wallace has a wonderful description of time on his site at <a href="http://home.attbi.com/~davidwallace2000/h8/notes.htm#relativity"><i>Einstein and the Virtual H8</i></a>. Here he introduces the concept of "tau" or scaled time. Variable-speed time. Omnipotence has its compensations.</p><p><a href="#top" onMouseOver="self.status='go to the top of this page'; return true">go to top</a></p><hr><a name="creation"></a><p><b>Time Creation</b></p><p>This topic is much more prosaic.</p><p>The Macintosh Time Manager, part of the Processes tool set, provides a mechanism that allows a task to be scheduled to execute periodically to a high degree of accuracy. We don't need a task to run, we just need a flag. And, luckily, that's provided as well.</p><p>Before starting the scheduling loop we insert and prime a Time Manager record:</p><pre>    InsTime   ( (QElem *) &msTickRecord    );    PrimeTime ( (QElem *) &msTickRecord, 1 );</pre><p>(That '1' in the PrimeTime call is one millisecond.) The timer is re-primed just before completing time-related processing in the scheduling loop.</p><p>When the 1ms time period expires, the Time Manager sets a flag in our record which can be tested:</p><pre>    // high bit off = 1ms has gone by    if ( ! (msTickRecord.qType & 0x8000) )    {        // start time-related processing</pre><p>This test is made at the top of the scheduling loop. Since it's a polled test, there can be some variability in the duration of a millisecond in the emulator. Consider the accuracy to be +/- 50% of the average execution thread in a call to h8Processing. That's a very small amount of variation.</p><p><a href="#top" onMouseOver="self.status='go to the top of this page'; return true">go to top</a></p><hr><a name="pacing"></a><p><b>Processor Pacing</b></p><p>In response to a bug in the original HDOS 2.0 driver that made it impossible to boot on a fast system, a processor pacing mechanism was added to the emulator. This was an important addition even without the bug, as it helps provide a more accurate emulation experience on fast host equipment.</p><p>The original pacing mechanism was based on instruction counts and only roughly emulated the actual speed of a real H8. In R5, the pacing feature is based on 8080A machine cycles.</p><ul><table border="1" cellspacing="0" cellpadding="4">	<caption><font size="-1"><p><b>Pacing Counts</b></p></font></caption><tr align="left" valign="top">	<th class="body"><font size="-1"><p>Release</p></font></th>	<th class="body"><font size="-1"><p>Speed</p></font></th>	<th class="body"><font size="-1"><p>Count per Millisecond</p></font></th></tr><tr align="left" valign="top">	<td class="body" align="center" rowspan="4"><font size="-1"><p>R5</p></font></td>	<td class="body" align="center"><font size="-1"><p>2 mhz</p></font></td>	<td class="body" align="center"><font size="-1"><p>2048</p></font></td></tr><tr align="left" valign="top">	<td class="body" align="center"><font size="-1"><p>4 mhz</p></font></td>	<td class="body" align="center"><font size="-1"><p>4096</p></font></td></tr><tr align="left" valign="top">	<td class="body" align="center"><font size="-1"><p>8 mhz</p></font></td>	<td class="body" align="center"><font size="-1"><p>8192</p></font></td></tr><tr align="left" valign="top">	<td class="body" align="center"><font size="-1"><p>Turbo</p></font></td>	<td class="body" align="center"><font size="-1"><p>unlimited</p></font></td></tr></table></ul><p>The 4- and 8-mhz speeds were added to give very fast Mac's the ability to speed things up without completely ruining the emulation experience in Turbo mode.</p><p>After each instruction is dispatched, the number of cycles that instruction would have taken on a real 8080A is deducted from the pacing count. Instructions are dispatched until either the pacing count is exhausted or the millisecond timer expires.</p><p>In order to minimize clock drift (ref: <a href="design_perf.html#drift" onMouseOver="self.status='Go to performance'; return true">clock drift</a>), timed internal processing is started when either the pacing count is expired or the millisecond timer expires. If this internal processing is completed before the clock expires, we wait for the clock to tick before re-arming the clock and refreshing the pacing cycle count. </p><img src="gfx/perf_f1.gif" width="504" height="216"><p>Pacing was in H8 Processing prior to release 5. It was moved into the scheduling loop in Release 5 in order to facilitate this change.</p><p><a href="#top" onMouseOver="self.status='go to the top of this page'; return true">go to top</a></p><hr><a name="distribution"></a><p><b>Time Distribution</b></p><p>On each millisecond, the following tasks are run:</p><table border="1" cellspacing="0" cellpadding="4">	<caption><font size="-1"><p><b>Time Distribution</b></p></caption><tr align="left" valign="top">	<th class="body"><font size="-1"><p>Routine</p></th>	<th class="body" align="center"><font size="-1"><p>Run every...</p></th>	<th class="body"><font size="-1"><p>Purpose</p></th></tr><tr align="left" valign="top">	<td class="body"><font size="-1">	<p><a href="design_pam8.html#leds" onMouseOver="self.status='Go to pam/8 gui'; return true">panelRefresh</a></p></td>	<td class="body" align="center"><font size="-1"><p>*</p></td>	<td class="body"><font size="-1"><p>Redraw the LEDs.</p></td></tr><tr align="left" valign="top">	<td class="body"><font size="-1">	<p><a href="design_arch.html#events" onMouseOver="self.status='Go to system architecture'; return true">doMacInterface</a></p></td>	<td class="body" align="center"><font size="-1"><p>*</p></td>	<td class="body"><font size="-1"><p>Check the Macintosh event queue and process up to one event.</p></td></tr><tr align="left" valign="top">	<td class="body"><font size="-1">	<p><a href="design_serial.html#mddesign" onMouseOver="self.status='Go to serial i/o'; return true">mdProcessing</a></p></td>	<td class="body" align="center"><font size="-1"><p>10ms</p></td>	<td class="body"><font size="-1"><p>Move characters between input and output queues.</p></td></tr><tr align="left" valign="top">	<td class="body"><font size="-1"><p>(local)</p></td>	<td class="body" align="center"><font size="-1"><p>**</p></td>	<td class="body"><font size="-1"><p>Remove key value from the PAM/8 input port.</p></td></tr><tr align="left" valign="top">	<td class="body"><font size="-1">	<p>h8Clock</p></td>	<td class="body" align="center"><font size="-1"><p>1ms</p></td>	<td class="body"><font size="-1"><p>Schedule clock interrupt every other call.</p></td></tr><tr align="left" valign="top">	<td class="body"><font size="-1">	<p>ioClock</p></td>	<td class="body" align="center"><font size="-1"><p>1ms</p></td>	<td class="body"><font size="-1"><p>Count down and clear the sound channel after H8 "beep."</p></td></tr><tr align="left" valign="top">	<td class="body"><font size="-1">	<p><a href="design_pam8.html#leds" onMouseOver="self.status='Go to pam/8 gui'; return true">panelClock</a></p></td>	<td class="body" align="center"><font size="-1"><p>1ms</p></td>	<td class="body"><font size="-1"><p>Age and expire LEDs that have not been refreshed.</p></td></tr><tr align="left" valign="top">	<td class="body"><font size="-1">	<p><a href="design_h17.html#format" onMouseOver="self.status='Go to h-17 disk system'; return true">h17Clock</a></p></td>	<td class="body" align="center"><font size="-1"><p>1ms</p></td>	<td class="body"><font size="-1"><p>Generate hole-detect pulses to make the disks "spin." Also advance the read head when scanning for the correct sector.</p></td></tr><tr align="left" valign="top">	<td class="body"><font size="-1">	<p><a href="design_h19.html#pacing" onMouseOver="self.status='Go to h-19 terminal'; return true">h19Clock</a></p></td>	<td class="body" align="center"><font size="-1"><p>1ms</p></td>	<td class="body"><font size="-1"><p>Cut off batch collection and process outbound characters; pace inbound characters at 500cps (one every other call); display the delayed cursor; blink the block cursor.</p></td></tr><tr align="left" valign="top">	<td class="body"><font size="-1">	<p><a href="design_serial.html#mddesign" onMouseOver="self.status='Go to serial i/o'; return true">mdClock</a></p></td>	<td class="body" align="center"><font size="-1"><p>1ms</p></td>	<td class="body"><font size="-1"><p>Pace inbound characters at 500cps (one every other call).</p></td></tr></table><br><br><table border="0" cellspacing="0" cellpadding="2"><tr align="left" valign="top">	<td class="body"><font size="-1"><p>*</p></td>	<td class="body"><font size="-1"><p>If we are in the foreground, this happens every 25ms. If we are in the background, it happens every 10ms.</p></td></tr><tr align="left" valign="top">	<td class="body"><font size="-1"><p>**</p></td>	<td class="body"><font size="-1"><p>This is scheduled for 30ms after the key value is placed on the port.</p></td></tr></table><p>These routines are all run after the pacing count is exhausted or the millisecond timer expires and before it is restarted, so by definition they are run outside the H8's time universe, although, depending on host system speed and the selected H8 clock rate, they don't necessarily cause clock drift.</p><p><a href="#top" onMouseOver="self.status='go to the top of this page'; return true">go to top</a></p></font><br></td></tr></table><!-- Footer area -- common to all pages --><hr><div class="c1"><font size="-1"><a href="index.html" onMouseOver="self.status='Go to Heath8080A home page'; return true">home</a>&nbsp;<a href="release.html" onMouseOver="self.status='Go to release page'; return true">release</a>&nbsp;<a href="support.html" onMouseOver="self.status='Go to support page'; return true">support</a>&nbsp;<a href="design.html" onMouseOver="self.status='Go to design page'; return true">design</a>&nbsp;<a href="resources.html" onMouseOver="self.status='Go to resources page'; return true">resources</a>&nbsp;<a href="legal.html" onMouseOver="self.status='Go to legal page'; return true">legal</a>&nbsp;<a href="sitemap.html" onMouseOver="self.status='Go to site map'; return true">site map</a>&nbsp;</font></div><hr><br></body>
<!-- Mirrored from davidwallace2000.home.comcast.net/~davidwallace2000/h8/project8080_archive/design_time.html by HTTrack Website Copier/3.x [XR&CO'2010], Mon, 10 Sep 2012 13:15:34 GMT -->
</html>
